<!DOCTYPE html>
<html lang="en">

<head>
    <title>CRM | Add Case</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href="http://cdn.bootcss.com/material-design-icons/2.2.0/iconfont/material-icons.css" rel="stylesheet">
    <link href="http://cdn.bootcss.com/materialize/0.97.5/css/materialize.min.css" rel="stylesheet" media="screen,projection">
    <style type="text/css">
    .info_seg {
        margin-left: 5%;
        margin-right: 5%;
        margin-top: 7%;
        margin-bottom: 7%;
        padding: 20px;
        background-color: white;
    }

    .submit_btn {
        margin-left: 80px;
        margin-bottom: 80px;
    }

    .seg_header {
        padding: 10px;
        font-size: 15pt;
        color: rgb(90, 90, 90);
    }

    .res_header {
        padding: 10px;
        padding-left: 0px;
        font-size: 13pt;
        color: rgb(110, 110, 110);
    }

    .description {
        padding: 10px;
        font-size: 12pt;
        color: rgb(110, 110, 110);
    }

    .breadcrumb:last-child {
        color: rgba(255, 255, 255, 0.7)
    }
    </style>
</head>

<body>
    <div class="navbar-fixed">
        <nav>
            <div class="nav-wrapper" style="background-color: rgb(105,165,237)">
                <a href="index.html" style="padding-left:3%;font-size:15pt;text-decoration:none;">客户关系管理系统(CRM)</a>
                <ul id="nav-mobile" class="right hide-on-med-and-down">
                    <li style="font-size: 35pt;"><a href="cases.html">最近记录</a></li>
                    <li style="font-size: 35pt;"><a onclick="profile();">学校资料</a></li>
                    <li style="font-size: 35pt;"><a onclick="explore();">报名表</a></li>
                    <li style="font-size: 35pt;"><a onclick="logout();">登出</a></li>
                </ul>
            </div>
        </nav>
    </div>

<div class="card info_seg" style="font-size: 15pt;">
    <div class="seg_header">
        School Case
        <a class="waves-effect blue lighten-2 btn" style="float: right;font-size: 12pt; margin-left: 20px;" onclick="del();">删除记录</a>

        <a class="waves-effect blue lighten-2 btn" style="float: right;font-size: 12pt;" onclick="save();">保存记录</a>
    </div><br/><br/>


  <div class="row blue-text text-lighten-1">

        <div class="input-field col s12 m4">
            <select id="type">
                <option value="" disabled selected>方式</option>
                <option value="电话">电话</option>
                <option value="邮件">邮件</option>
                <option value="面谈">面谈</option>
                <option value="快递">快递</option>
            </select>
        </div>

      <div class="input-field col s12 m4">
        <select id="status">
            <option value="" disabled selected>状态</option>
            <option value="待完成">未完成</option>
            <option value="已完成">已完成</option>
        </select>
      </div>
      <div class="input-field col s12 m4">
          <select id="purpose">
              <option value="" disabled selected>目的</option>
              <option value="项目宣传">项目宣传</option>
          </select>
      </div>
</div>

 <div class="row blue-text text-darken-2">

     <div class="input-field col s12 m4">
         <select id="teacher" onchange="changeRelationship()"></select>
     </div>

     <div class="input-field col s12 m4">
         <select id="project"></select>
     </div>

     <div class="input-field col s12 m4">
         <select id="relationship">
            <option value="" disabled selected>客情关系</option>
            <option value="支持">支持</opition>
            <option value="中立">中立</opition>
            <option value="反对">反对</opition>
            <option value="封闭">封闭</opition>
            <option value="联系不上">联系不上</opition>
            <option value="不详">不详</opition>
         </select>
     </div>
 </div>

<div class="row blue-text text-darken-2">
     <div class="input-field col s12 m4">
         <select id="stdNote">
            <option value="" disabled selected>标准笔记</option>
            <option value="电话不通">电话不通</opition>
            <option value="直接挂断">直接挂断</opition>
         </select>
     </div>
 </div>
 <div class="row blue-text text-darken-2">
    <div class="input-field col s12 m8">
          <input placeholder="笔记" id="note" type="text" class="validate">
          <label for="note">笔记</label>
    </div>
 </div>




</div>
    <!-- <a href="basic.html" class="waves-effect waves-light btn-large submit_btn tooltipped" data-position="right" data-tooltip="Go on to the next section!">Next</a> -->
    <footer class="page-footer" style="background-color:rgba(255,255,255,0)">
        </div>
        <div class="footer-copyright">
            <div class="container">
                © 2016 Youth Impact China
                <a class="grey-text text-lighten-4 right" target="_blank" href="http://soe-awards.cn">Offcial Site</a>
            </div>
    </footer>
    <script src="http://cdn.bootcss.com/jquery/2.2.0/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/materialize/0.97.5/js/materialize.min.js"></script>
    <script src="assets/js/jquery.cookie.js"></script>
    <script type="text/javascript">
    function addRecord(school) {
      var HTMLContent = document.getElementById('Record').innerHTML;
      for (var i in school.school_cases) {

        HTMLContent = HTMLContent +
            "<tr onclick=change(\'" + school.school_cases[i]._id + "\')>" +
              "<td class='res_header'>" + school.school_cases[i].time + "</td>" +
              "<td class='res_header'>" + school.school_cases[i].type +"</td>" +
              "<td class='res_header'>" + school.school_cases[i].status + "</td>" +
              "<td class='res_header'>" + school.school_cases[i].teacher.name + "</td>" +
              "<td class='res_header'>" + school.school_cases[i].sender.name + "</td>" +
              "<td class='res_header'>" + school.school_cases[i].project.name + " | "+ school.school_cases[i].project.year + "</td>" +
              "<td class='res_header'>" + school.school_cases[i].purpose +"</td>" +
              "<td class='res_header'>" + school.school_cases[i].note +"</td>" +
            "</tr>"
        document.getElementById('Record').innerHTML = HTMLContent;
      }
    }
    $(document).ready(function() {
        if (!$.cookie('user') || $.cookie('user') == "no" || !$.cookie('id')) {
            location.href = "index.html";
        }
        var pickColor = "rgb(151,205,251)";
        document.body.style.background = "-webkit-gradient(linear, 0% 0%, 0% 100%,from(#639AC8), to(" + pickColor + "))"

        $.ajax({
            url: "http://api.youthimpactchina.com/project/all",
            method: "GET",
            success: function(data) {
                var HTMLContent = "";
                HTMLContent = HTMLContent  + "<option value='' disabled selected>项目</option>";
                for (var item in data) {
                    HTMLContent = HTMLContent + '<option value="'+ data[item]._id +'">'+ data[item].name + " | " + data[item].year +'</option>';
                }
                $("#project").html(HTMLContent);
                $.ajax({
                    url: "http://api.youthimpactchina.com/crm/school/get_info",
                    method: "GET",
                    data: {id: localStorage['school']},
                    success: function(data) {
                        var HTMLContent = "";
                        HTMLContent = HTMLContent  + "<option value='' disabled selected>联系老师</option>";
                        HTMLContent = HTMLContent  + "<option value='office'>学校办公室</option>";
                        for (var item in data.teachers) {
                            HTMLContent = HTMLContent + '<option value=\''+ JSON.stringify(
                                data.teachers[item] )+'\'>'+ data.teachers[item].profile.given_name+ data.teachers[item].profile.first_name +" | " + data.teachers[item].profile.position +'</option>';
                        }
                        $("#teacher").html(HTMLContent);
                        if (localStorage['case'] !== undefined && localStorage['case']!='new') {

                            $.ajax({
                                url: "http://api.youthimpactchina.com/crm/case",
                                method: "GET",
                                data: {
                                    id: localStorage['case']
                                },
                                success: function(data) {

                                    var notes = data.note.split('-');

                                    $('#type').val(data.type);
                                    $('#status').val(data.status);
                                    $('#purpose').val(data.purpose);
                                    $('#teacher').val(data.teacher._id);
                                    $('#project').val(data.project);
                                    $('#stdNote').val(notes[0]);
                                    $('#note').val(notes[1]);
                                    $('select').material_select();
                                }
                            })
                        } else $('select').material_select();

                    }
                })
            }
        });
    });
    function del() {
        if (localStorage['case'] != undefined &&
            localStorage['case'] != 'new')
        $.ajax({
            url: "http://api.youthimpactchina.com/crm/del/case",
            method: "POST",
            data: {
                id: localStorage['case']
            },
            success: function(data) {
                alert(data);
                localStorage['case'] = "new";
                location.href = "contactdetail.html";
            }
        });
    }
    function logout() {
        $.cookie('user', 'no');
        location.href = 'index.html';
    }

    function changeRelationship(){
        var getTeacher = JSON.parse($("#teacher").val());
        $("relationship").val(getTeacher.profile.relationship);
        $('select').material_select('destroy');
        $('select').material_select();

        // 应该是好了
    }
    function save() {
        var type = $('#type').val();
        var status = $('#status').val();
        var purpose = $('#purpose').val();
        var relationship = $('#relationship').val();
        if ($('#teacher').val()== 'office') {
            var teacher = "56fffb5309f778b2288b4567"; 
        }else{
            var teacher = JSON.parse($('#teacher').val())._id;
        }
        
        var project = $('#project').val();
        var note = $('#stdNote').val()+'-'+$('#note').val();
        var getUserId = $.cookie('id');

        var TeacherProfle = JSON.parse($('#teacher').val());
        TeacherProfle.profile.relationship = $('#relationship').val();

        localStorage['teacher'] = teacher;
        if (localStorage['case'] != undefined && localStorage['case'] != 'new') {
            $.ajax({
                url: "http://api.youthimpactchina.com/crm/school/case/update",
                method: "POST",
                data: {
                    id: localStorage['case'], type: type, status: status, purpose: purpose, note: note,
                    senderID: getUserId, schoolID: localStorage['school'], projectID: project, teacherID: teacher
                },
                success: function(data) {
                    alert(data);
                    // $.ajax({
                    //     url: "http://api.youthimpactchina.com/crm/teacher/profile/update",
                    //     method: "POST",
                    //     data: {
                    //         id: teacher,
                    //         profile: TeacherProfle,
                    //         email: $('#email').val()
                    //     },
                    //     success: function(data) {
                    //         alert(data);
                    //     }
                    // })
                    // 大概是这个样子。我没测试
                    // location.href = "contactdetail.html";
                }
            });
        }
        else $.ajax({
            url: "http://api.youthimpactchina.com/crm/school/case/create",
            method: "POST",
            data: {
                type: type, status: status, purpose: purpose, note: note,
                senderID: getUserId, schoolID: localStorage['school'], projectID: project, teacherID: teacher
            },
            success: function(data) {
                alert(data);
                // location.href = "contactdetail.html";
            }
        })

    }
    // let {type, status, purpose, note, senderID, schoolID, projectID, teacherID}
    function profile() {
        location.href = "region.html";

    }
    </script>
</body>

</html>
