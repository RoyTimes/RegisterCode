<!DOCTYPE html>
<html lang="en">

<head>
    <title>CRM | Contact Detail</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href="http://cdn.bootcss.com/material-design-icons/2.2.0/iconfont/material-icons.css" rel="stylesheet">
    <link href="http://cdn.bootcss.com/materialize/0.97.5/css/materialize.min.css" rel="stylesheet" media="screen,projection">
    <style type="text/css">
    .info_seg {
        margin-left: 5%;
        margin-right: 5%;
        margin-top: 7%;
        margin-bottom: 7%;
        padding: 20px;
        background-color: white;
    }

    .submit_btn {
        margin-left: 80px;
        margin-bottom: 80px;
    }

    .seg_header {
        padding: 10px;
        font-size: 15pt;
        color: rgb(90, 90, 90);
    }

    .res_header {
        padding: 10px;
        padding-left: 0px;
        font-size: 13pt;
        color: rgb(110, 110, 110);
    }

    .description {
        padding: 10px;
        font-size: 12pt;
        color: rgb(110, 110, 110);
    }

    .breadcrumb:last-child {
        color: rgba(255, 255, 255, 0.7)
    }
    </style>
</head>

<body>
    <div class="navbar-fixed">
        <nav>
            <div class="nav-wrapper" style="background-color: rgb(105,165,237)">
                <a href="index.html" style="padding-left:3%;font-size:15pt;text-decoration:none;">客户关系管理系统(CRM)</a>
                <ul id="nav-mobile" class="right hide-on-med-and-down">
                    <li style="font-size: 35pt;"><a onclick="profile();">学校资料</a></li>
                    <li style="font-size: 35pt;"><a onclick="explore();">报名表</a></li>
                    <li style="font-size: 35pt;"><a onclick="logout();">登出</a></li>
                </ul>
            </div>
        </nav>
    </div>
    <div class="card info_seg" style="font-size: 15pt">
        <div class="seg_header">
            基本信息
            <a class="waves-effect blue lighten-2 btn" style="float: right;font-size: 12pt;" onclick="save();">save</a>
        </div>
        <br/>
        <br/>
        <div class="row">
            <div class="input-field col s12 m4">
                <input placeholder="姓" id="last_name" type="text" class="validate" />
                <label for="last_name">姓</label>
            </div>
            <div class="input-field col s12 m4">
                <input placeholder="名" id="first_name" type="text" class="validate" />
                <label for="first_name">名</label>
            </div>
            <div class="input-field col s12 m4">
                <select id="prefix">
                    <option value="" disabled selected>称谓</option>
                    <option value="女士">女士</option>
                    <option value="先生">先生</option>
                </select>
                <label>称谓</label>
            </div>
        </div>
        <!-- 角色  手机  办公室直线   电子邮箱    QQ号码    客情关系    详细 -->
        <div class="row">
            <div class="input-field col s12 m4">
                <select id="position">
                    <option value="" disabled selected>职位</option>
                    <option value="国际部主任">国际部主任</option>
                    <option value="国际部副主任">国际部副主任</option>
                    <option value="校长">校长</option>
                    <option value="副校长">副校长</option>
                    <option value="学术校长">学术校长</option>
                    <option value="校长助理">校长助理</option>
                    <option value="教务主任">教务主任</option>
                    <option value="团委书记">团委书记</option>
                    <option value="升学指导">升学指导</option>
                    <option value="活动指导">活动指导</option>
                    <option value="招生老师">招生老师</option>
                    <option value="任课老师">任课老师</option>
                    <option value="不详">不详</option>
                </select>
                <label>职称</label>
            </div>

            <div class="input-field col s12  m4">
                <select id="role">
                    <option value="" disabled selected>角色</option>
                    <option value="批准者">批准者</option>
                    <option value="决策者">决策者</option>
                    <option value="推动者">推动者</option>
                    <option value="执行者">执行者</option>
                    <option value="传达者">传达者</option>
                    <option value="不详">不详</option>
                </select>
                <label>角色</label>
            </div>
            <div class="input-field col s12 m4">
                <select id="relationship">
                    <option value="" disabled selected>客情关系</option>
                    <option value="良好">良好</option>
                    <option value="中立">中立</option>
                    <option value="反对">反对</option>
                    <option value="封闭">封闭</option>
                    <option value="不详">不详</option>
                </select>
                <label>客情关系</label>
            </div>
        </div>

        <div class="row">
            <div class="input-field col s12 m3">
                <input placeholder="手机" id="mobile" type="text" class="validate" />
                <label for="mobile">手机</label>
            </div>
            <div class="input-field col s12 m3">
                <input placeholder="直线座机" id="telephone" type="text" class="validate" />
                <label for="telephone">直线座机</label>
            </div>
            <div class="input-field col s12 m3">
                <input placeholder="电子邮箱" id="email" type="text" class="validate" />
                <label for="email">电子邮箱</label>
            </div>
            <div class="input-field col s12 m3">
                <input placeholder="QQ号码" id="qq" type="text" class="validate" />
                <label for="qq">QQ号码</label>
            </div>
        </div>

        <div class="row">
            <div class="input-field col s12 m6">
                <select id="employer">
                    <option value="" disabled selected>编制</option>
                    <option value="公立学校">公立学校</option>
                    <option value="私立学校">私立学校</option>
                    <option value="第三方机构">第三方机构</option>
                    <option value="不详">不详</option>
                </select>
                <label>编制</label>
             </div>

            <div class="input-field col s12 m6">
                <select id="discipline">
                    <option value="" disabled selected>学科</option>
                    <option value="英语">英语</option>
                    <option value="政治">政治</option>
                    <option value="地理">地理</option>
                    <option value="历史">历史</option>
                    <option value="数理化">数理化</option>
                    <option value="行政">行政</option>
                    <option value="不详">不详</option>
                </select>
                <label>学科</label>
             </div>
        </div>

        <div class="row">
            <div class="input-field col s12 m12">
                <input placeholder="爱好" id="interests" type="text" class="validate" />
                <label for="interest">爱好</label>
            </div>

        </div>

        </div>
    </div>
    <!--
    <input placeholder="Placeholder" id="first_name" type="text" class="validate">
          <label for="first_name">First Name</label>
   角色  手机  办公室直线   电子邮箱    QQ号码    客情关系    详细
 --><div class="car info_seg">
     <div class="row">
         <div class="input-field col s12 m4">
             <select id="template"></select>
         </div>
         <div class="input-field col s12 m4">
             <select id="sender"></select>
         </div>
         <div class="input-field col s12 m4">
             <input placeholder="Send To" id="to" type="text" class="validate">
             <label for="to">To</label>
         </div>
     </div><br/><br/>
     <div class="row">
         <a onclick="send_email()" style="margin-left: 40%" class="waves-effect waves-light btn">Send</a>
     </div>
 </div>
    <div class="card info_seg" style="font-size: 15pt;">
        <div class="seg_header">
            <span>联系人交互纪录</span>
            <a class="waves-effect blue lighten-2 btn" style="float: right;font-size: 12pt;" target="_blank" href="add_case.html">增加纪录</a>
        </div>
        <table class="highlight">
            <thead>
                <tr>
                    <th data-field="Date"><span class="res_header">日期</span></th>
                    <th data-field="Type"><span class="res_header">类型</span></th>
                    <th data-field="Status"><span class="res_header">状态</span></th>
                    <th data-field="Contact"><span class="res_header">联系人</span></th>
                    <th data-field="Worker"><span class="res_header">发起人</span></th>
                    <th data-field="Project"><span class="res_header">项目</span></th>
                    <th data-field="Aim"><span class="res_header">目的</span></th>
                    <th data-field="Note"><span class="res_header">笔记</span></th>
                </tr>
            </thead>
            <tbody id="Record"></tbody>
        </table>
    </div>
    <!-- <a href="basic.html" class="waves-effect waves-light btn-large submit_btn tooltipped" data-position="right" data-tooltip="Go on to the next section!">Next</a> -->
    <footer class="page-footer" style="background-color:rgba(255,255,255,0)">
        <div class="footer-copyright">
            <div class="container">
                © 2016 Youth Impact China
                <a class="grey-text text-lighten-4 right" target="_blank" href="http://soe-awards.cn">Offcial Site</a>
            </div>
    </footer>
    <script src="http://cdn.bootcss.com/jquery/2.2.0/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/materialize/0.97.5/js/materialize.min.js"></script>
    <script src="assets/js/jquery.cookie.js"></script>
    <script type="text/javascript">
    function logout() {
        $.cookie('user', 'no');
        location.href = 'index.html';
    }
    function send_email() {
		var template = JSON.parse($('#template').val());
		var sender = $('#sender').val();
		$.ajax({
			url: "http://api.youthimpactchina.com/mail",
			method: "POST",
			data: {
				from: sender,
				to: $('#to').val(),
				subject: template.subject,
				template: template.name,
				data: JSON.stringify({
					last_name: $('#last_name').val(),
                    school_name: localStorage['school_name']
				})
			},
			success: function(data, status, xhr) {
				console.log(xhr);
				alert(data);
			},
			error: function(data, status, xhr) {
				console.log(xhr);
			}
		});
        $.ajax({
            url: "http://api.youthimpactchina.com/crm/school/case/create",
            method: "POST",
            data: {
                type: "邮件", status: "已完成", purpose: "项目宣传", note: JSON.parse($('#template').val()).name,
                senderID: $.cookie('id'), schoolID: localStorage['school'], projectID: "56f8cd20d2ef370f2984e808", teacherID: localStorage['teacher']
            },
            success: function(data) {
                alert(data);
            }
        })
	}
    function addRecord(casecase) {
      var HTMLContent = document.getElementById('Record').innerHTML;
        HTMLContent = HTMLContent +
            "<tr onclick=change(\'" + casecase._id + "\')>" +
              "<td class='res_header'>" + casecase.time + "</td>" +
              "<td class='res_header'>" + casecase.type +"</td>" +
              "<td class='res_header'>" + casecase.status + "</td>" +
              "<td class='res_header'>" + casecase.teacher.profile.first_name+ casecase.teacher.profile.given_name  + "</td>" +
              "<td class='res_header'>" + casecase.sender.first_name + casecase.sender.given_name + "</td>" +
              "<td class='res_header'>" + casecase.project.name + " | "+ casecase.project.year + "</td>" +
              "<td class='res_header'>" + casecase.purpose +"</td>" +
              "<td class='res_header'>" + casecase.note +"</td>" +
            "</tr>"
        document.getElementById('Record').innerHTML = HTMLContent;
    }

    $(document).ready(function() {
        var pickColor = "rgb(151,205,251)";
        document.body.style.background = "-webkit-gradient(linear, 0% 0%, 0% 100%,from(#639AC8), to(" + pickColor + "))"

        var teacherID = localStorage['teacher'];
        if (teacherID != "new") {
            $.ajax({
                url: "http://api.youthimpactchina.com/crm/case/by_teacher",
                method: "GET",
                data: {
                    id: teacherID
                },
                success: function(data) {
                    for (var item in data) {
                        addRecord(data[item]);
                    }
                }
            });


            $.ajax({
                url: "http://api.youthimpactchina.com/crm/teacher/profile/find",
                method: "GET",
                data: {
                    id: teacherID
                },
                success: function(data) {
                    $('#last_name').val(data.profile.given_name);
                    $('#first_name').val(data.profile.first_name);
                    $("#position").val(data.profile.position);
                    $("#prefix").val(data.profile.prefix);
                    $('#role').val(data.profile.role);
                    $('#relationship').val(data.profile.relationship);
                    $('#mobile').val(data.profile.mobile);
                    $('#telephone').val(data.profile.telephone);
                    $('#email').val(data.email);
                    $('#qq').val(data.profile.qq);
                    $('#to').val(data.email);
                    $('#discipline').val(data.profile.discipline);
                    $('#employer').val(data.profile.employer);
                    $('#interests').val(data.profile.interests);

                    $.ajax({
            			url: "http://api.youthimpactchina.com/mail/template",
            			method: "GET",
            			success: function(data) {
            				var HTMLContent = "<option value='' disabled selected>模板</option>";
            				for (var item in data) {
                                if (item == "general") {
                                    HTMLContent = HTMLContent + "<option value=\'"+ JSON.stringify({
                                        name:item , subject: data[item].mail_title
                                    }) +"\'>"+  data[item].name+"</option>";
                                }
            				}
            				$('#template').html(HTMLContent);
            				$.ajax({
            					url: "http://api.youthimpactchina.com/mail/sender",
            					method: "GET",
            					success: function(data) {
            						var HTMLContent = "<option value='' disabled selected>发送邮箱</option>";
            						for (var item in data) {
            							HTMLContent = HTMLContent + "<option value=\'"+ data[item] +"\'>"+data[item]+"</option>";
            						}
            						$('#sender').html(HTMLContent);
            						$('select').material_select();
            					}
            				})
            			}
            		});
                }
            });
        } else {$('select').material_select();}
    });

    function save() {
        var data = {};
        data['first_name'] = $('#first_name').val();
        data['given_name'] = $('#last_name').val();
        data['position'] = $("#position").val();
        data['prefix'] = $("#prefix").val();
        data['role'] = $('#role').val();
        data['relationship'] = $('#relationship').val();
        data['mobile'] = $('#mobile').val();
        data['telephone'] = $('#telephone').val();
        // data['email'] = $('#email').val();
        data['qq'] = $('#qq').val();
        data['discipline'] = $('#discipline').val();
        data['employer'] = $('#employer').val();
        data['interests'] = $('#interests').val();
        for (var item in data) {
            if (data[item] == null)
                data[item] = "";
        }
        if (localStorage['teacher'] != 'new') {
            $.ajax({
                url: "http://api.youthimpactchina.com/crm/teacher/profile/update",
                method: "POST",
                data: {
                    id: localStorage['teacher'],
                    profile: JSON.stringify(data),
                    email: $('#email').val()
                },
                success: function(data) {
                    alert(data)
                }
            })
        } else {
            $.ajax({
                url: "http://api.youthimpactchina.com/crm/school/add_contact",
                method: "POST",
                data: {
                    schoolID: String(localStorage['school']),
                    profile: JSON.stringify(data),
                    email: $('#email').val()
                },
                success: function(data) {
                    alert(data);
                }
            })
        }

    }
    function change(id) {
        localStorage['case'] = id;
        location.href = "add_case.html";
    }
    function profile() {
        location.href = "region.html";

    }
    </script>
</body>

</html>
